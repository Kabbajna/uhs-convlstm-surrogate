# Figure Generation Scripts

This folder contains Python scripts to reproduce all figures from the paper:

**"Simulation-Based Staged Decoupling of Mobility, Heterogeneity and Hysteresis Effects in Underground Hydrogen Storage"**

## üìä Figures Overview

| Script | Figure | Description | Data Required |
|--------|--------|-------------|---------------|
| `Figure4_Ablation_Study.py` | Figure 4 | Ablation study comparing model architectures | Trained models (all 4) |
| `Figure5_Prediction_vs_GT.py` | Figure 5 | Prediction vs ground truth comparison | ConvLSTM-SS model + test data |
| `Figure6_Phase_Analysis.py` | Figure 6 | Phase-specific error analysis | ConvLSTM-SS model + test data |
| `Figure7_Spatial_Error.py` | Figure 7 | Spatial distribution of errors | ConvLSTM-SS model + test data |
| `Figure8_Transfer_Learning.py` | Figure 8 | Zero-shot transfer to high-fidelity | ConvLSTM-SS model + high-fidelity data |

## Prerequisites

### Python Dependencies

```bash
pip install numpy matplotlib seaborn scipy torch
```

Or use the project requirements:
```bash
pip install -r ../requirements.txt
```

### Required Data and Models

1. **Trained models** (from `../checkpoints/`):
   - `convlstm_ss_best.pt` (ConvLSTM with Scheduled Sampling)
   - `convlstm_tf_best.pt` (ConvLSTM with Teacher Forcing)
   - `unet_baseline_best.pt` (3D U-Net)
   - `fno_baseline_best.pt` (FNO)

2. **Test data**:
   - Medium-fidelity test set (75 simulations)
   - High-fidelity test set (20 simulations) for Figure 8

3. **Evaluation results** (JSON files with metrics):
   - Generated by running evaluation scripts first

## Quick Start

### Step 1: Train All Models (or download checkpoints)

```bash
# Train main model
cd ../final_codes_github
python 01_ConvLSTM_UNet_ScheduledSampling.py

# Train baselines for comparison
python 02_ConvLSTM_UNet_TeacherForcing.py
python 03_3D_UNet_Baseline.py
python 04_FNO_Baseline.py
```

### Step 2: Run Evaluation (generates metrics)

```bash
# This creates JSON files with R¬≤, MAE, etc.
python evaluate_all_models.py
```

### Step 3: Generate Figures

```bash
cd figure_generation

# Generate each figure
python Figure4_Ablation_Study.py
python Figure5_Prediction_vs_GT.py
python Figure6_Phase_Analysis.py
python Figure7_Spatial_Error.py
python Figure8_Transfer_Learning.py
```

Figures will be saved in: `../publication_figures/`

## Figure Details

### Figure 4: Ablation Study

**Compares 4 architectures**:
- ConvLSTM-UNet with Scheduled Sampling (R¬≤ = 0.990) ‚≠ê
- ConvLSTM-UNet with Teacher Forcing (R¬≤ = 0.071)
- 3D U-Net without LSTM (R¬≤ = -0.55)
- FNO (R¬≤ = -4.40)

**Output**: Bar chart showing single-step vs 15-month rollout R¬≤

**Usage**:
```bash
python Figure4_Ablation_Study.py
```

**Required**:
- All 4 trained models
- Evaluation results JSON

---

### Figure 5: Prediction vs Ground Truth

**Shows**: Side-by-side comparison of predicted vs actual gas saturation at 4 time points:
- 1st injection (month 3)
- 1st withdrawal (month 8)
- 2nd injection (month 11)
- 2nd withdrawal (month 14)

**Output**: 2√ó4 grid of saturation heatmaps with R¬≤ and MAE per phase

**Usage**:
```bash
python Figure5_Prediction_vs_GT.py
```

**Customization**:
```python
# Edit script to change which simulation to visualize
simulation_id = 5  # Default: simulation #5 from test set
```

---

### Figure 6: Phase Analysis

**Shows**: Error evolution across operational phases (injection vs withdrawal)

**Output**:
- MAE vs timestep colored by phase
- Box plots comparing error distributions

**Usage**:
```bash
python Figure6_Phase_Analysis.py
```

**Key finding**: Withdrawal phases have higher errors due to hysteresis complexity

---

### Figure 7: Spatial Error Distribution

**Shows**: Where errors are concentrated in the reservoir

**Output**:
- 2D heatmap of MAE (Y=10 cross-section)
- Radial error profile from injection well

**Usage**:
```bash
python Figure7_Spatial_Error.py
```

**Key finding**: Errors concentrated near well (MAE ‚âà 0.0109), decay to far-field (MAE ‚âà 0.0003)

---

### Figure 8: Transfer Learning

**Shows**: Zero-shot generalization from 20¬≥ to 40√ó40√ó20 grid

**Output**:
- Performance comparison (medium vs high-fidelity)
- Transfer learning workflow diagram

**Usage**:
```bash
python Figure8_Transfer_Learning.py
```

**Required**: High-fidelity test data and zero-shot evaluation results

**Key finding**: R¬≤ = 0.968 on high-fidelity without retraining!

---

## Reproducing Paper Figures Exactly

All figures use the **same style settings** for consistency:

```python
import matplotlib.pyplot as plt
import seaborn as sns

# Paper style
sns.set_style("whitegrid")
plt.rcParams['font.size'] = 10
plt.rcParams['font.family'] = 'Arial'
plt.rcParams['figure.dpi'] = 300
```

Figures are saved as:
- **PDF** (vector format for paper submission)
- **PNG** (for preview)

## Output Directory Structure

After running all scripts:

```
publication_figures/
‚îú‚îÄ‚îÄ Figure4_Ablation_Study.pdf
‚îú‚îÄ‚îÄ Figure4_Ablation_Study.png
‚îú‚îÄ‚îÄ Figure5_Prediction_vs_GT.pdf
‚îú‚îÄ‚îÄ Figure5_Prediction_vs_GT.png
‚îú‚îÄ‚îÄ Figure6_Phase_Analysis.pdf
‚îú‚îÄ‚îÄ Figure6_Phase_Analysis.png
‚îú‚îÄ‚îÄ Figure7_Spatial_Error.pdf
‚îú‚îÄ‚îÄ Figure7_Spatial_Error.png
‚îú‚îÄ‚îÄ Figure8_Transfer_Learning.pdf
‚îî‚îÄ‚îÄ Figure8_Transfer_Learning.png
```

## Troubleshooting

### "FileNotFoundError: No such file 'checkpoints/...'"

Make sure you've trained the models first or downloaded pretrained checkpoints.

### "ModuleNotFoundError: No module named 'seaborn'"

Install missing dependencies:
```bash
pip install seaborn matplotlib
```

### "ValueError: Could not load results JSON"

Run evaluation scripts first to generate metrics:
```bash
python ../evaluate_all_models.py
```

### Figures look different from paper

Check that you're using:
- Same random seed (42)
- Same data split (70/15/15)
- Same hyperparameters
- Test set (not validation or train)

## Customization

### Change Figure Resolution

Edit at the top of each script:
```python
plt.rcParams['figure.dpi'] = 600  # Higher resolution
```

### Change Color Scheme

```python
import seaborn as sns
sns.set_palette("colorblind")  # Colorblind-friendly
```

### Add Your Own Figures

Template for new figures:

```python
import matplotlib.pyplot as plt
import numpy as np
import torch

# Load model
model = torch.load('../checkpoints/convlstm_ss_best.pt')

# Load data
# ... your data loading code ...

# Create figure
fig, ax = plt.subplots(figsize=(10, 6))

# ... your plotting code ...

# Save
plt.savefig('../publication_figures/FigureX_MyFigure.pdf',
            dpi=300, bbox_inches='tight')
plt.savefig('../publication_figures/FigureX_MyFigure.png',
            dpi=300, bbox_inches='tight')
```

## Citation

If you use these visualization scripts, please cite:

```bibtex
@article{kabbaj2025uhs,
  title={Simulation-Based Staged Decoupling of Mobility, Heterogeneity and Hysteresis Effects in Underground Hydrogen Storage},
  author={Kabbaj, Narjisse},
  journal={Geoenergy Science and Engineering},
  year={2025}
}
```

## Contact

Questions about figure generation:
**Narjisse Kabbaj** - nkabbaj@effatuniversity.edu.sa

---

**Note**: These scripts expect specific data formats and model architectures. If you've modified the code, you may need to adjust the figure generation scripts accordingly.
